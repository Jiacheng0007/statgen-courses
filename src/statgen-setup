#!/usr/bin/env sos-runner
#fileformat=SOS1.0

[global]
# List of tutorials to launch
# see https://hub.docker.com/u/statisticalgenetics/ for a list of options
parameter: tutorials = []
fail_if(len(tutorials) == 0, msg = 'Please specify a list of tutorials to launch.')

[launch_1]
output: "cull_idle_servers.py", "jupyterhub_config.py"
bash:
    docker pull gaow/base-notebook
    curl -fsSL https://raw.githubusercontent.com/statgenetics/statgen-courses/master/src/cull_idle_servers.py -o cull_idle_servers.py
    curl -fsSL https://raw.githubusercontent.com/statgenetics/statgen-courses/master/src/jupyterhub_config.py -o jupyterhub_config.py

[launch_2]
input: for_each = 'tutorials', concurrent = False
docker_build: tag = f'{_tutorials}_hub', expand = True
    FROM gaow/base-notebook
    USER root
    COPY jupyterhub_config.py /srv/jupyterhub/jupyterhub_config.py
    COPY cull_idle_servers.py /srv/jupyterhub/cull_idle_servers.py
    RUN sed -i 's/IMAGE_NAME_PLACE_HOLDER/statisticalgenetics\/{_tutorials}/g' /srv/jupyterhub/jupyterhub_config.py

[launch_3]
import random, socket
ports = random.sample(range(1001, 8888), len(tutorials))
from sos.utils import get_output
ip = get_output("hostname -I | awk '{print $1}'").strip()
input: for_each = 'tutorials', concurrent = False
bash: expand = True
    # Stop currently running instances to start from scratch
    docker container stop $(docker container ls -q --filter name={_tutorials}) &> /dev/null || true
    docker container stop $(docker container ls -q --filter name={_tutorials}_hub) &> /dev/null || true
    # Get the relevant image
    docker pull statisticalgenetics/{_tutorials}
    # Start jupyterhub
    docker network inspect {_tutorials}_hub &>/dev/null || docker network create {_tutorials}_hub
    docker run --rm -it -d -v /var/run/docker.sock:/var/run/docker.sock --net {_tutorials}_hub --name {_tutorials}_hub -p{ports[_index]}:8000 {_tutorials}_hub
    # Create a shortcut to access from browser
    echo '<meta http-equiv="Refresh" content="0; url=http://{ip}:{ports[_index]}" />' > /var/www/html/{_tutorials}.html